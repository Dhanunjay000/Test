<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="p-4">
<div class="container mt-4">
  <h2 class="mb-4 text-center text-md-start">Customer Management</h2>


  <div class="row mb-3 g-2 align-items-center">
    <div class="col-12 col-md-6">
      <input id="searchInput" type="text" class="form-control" placeholder="Search customers">
    </div>
    <div class="col-6 col-md-3 text-end text-md-start">
      <button class="btn btn-secondary w-100" onclick="exportToCSV()">Export to CSV</button>
    </div>
    <div class="col-6 col-md-3 text-end">
      <a href="addEdit.html" class="btn btn-success w-100">Add Customer</a>
    </div>
  </div>


  <div class="table-responsive">
    <table class="table table-bordered" id="customerTable">
      <thead class="table-dark">
        <tr>
          <th onclick="sortTable('first_name')">First Name ⬍</th>
          <th onclick="sortTable('last_name')">Last Name ⬍</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Gender</th>
          <th>Address</th>
          <th>DOB</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-3">
    <p id="recordInfo" class="text-muted mb-2 mb-md-0 text-center text-md-start">Showing the records of <strong>All</strong></p>
    <nav>
      <ul class="pagination mb-0" id="pagination"></ul>
    </nav>
  </div>
</div>

  <script>
    let token = '';
    let customers = [];
    let filteredCustomers = [];
    let currentPage = 1;
    const rowsPerPage = 3;
    let currentSort = { key: null, direction: 'asc' };

    async function getToken() {
      const response = await axios.post('http://192.168.0.188/development/bhavana/local_prod/suitecrm/index.php?entryPoint=CustomerAPI');
      token = response.data.token;
    }

    async function fetchCustomers() {
      const res = await axios.get('http://192.168.0.188/development/bhavana/local_prod/suitecrm/index.php?entryPoint=CustomerAPI', {
        headers: { Authorization: `Bearer ${token}` }
      });
      customers = res.data;
      filteredCustomers = customers;
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      const start = (currentPage - 1) * rowsPerPage;
      const end = Math.min(start + rowsPerPage, filteredCustomers.length);
      const paginated = filteredCustomers.slice(start, end);
      const total =filteredCustomers.length
      let infoText = total === 0 ? `No Records found!`: `Showing records <strong>${start + 1}</strong> to <strong>${end}</strong> of <strong>${total}</strong>`;

      document.getElementById('recordInfo').innerHTML = infoText;
      paginated.forEach(customer => {
        tbody.innerHTML += `
          <tr>
            <td>${customer.first_name}</td>
            <td>${customer.last_name}</td>
            <td>${customer.email}</td>
            <td>${customer.phone}</td>
            <td>${customer.gender}</td>
            <td>${customer.address}</td>
            <td>${customer.dob}</td>
            <td>
              <a href="addEdit.html?id=${customer.id}" class="btn btn-sm btn-primary">Edit</a>
              <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')">Delete</button>
            </td>
          </tr>`;
      });

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredCustomers.length / rowsPerPage);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
          </li>`;
      }
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
    }

    async function deleteCustomer(id) {
      if (confirm('Are you sure you want to delete the user?')) {
        await axios.delete(`http://192.168.0.188/development/bhavana/local_prod/suitecrm/index.php?entryPoint=CustomerAPI&id=${id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        fetchCustomers();
      }
    }

    function sortTable(key) {
      const direction = currentSort.key === key && currentSort.direction === 'asc' ? 'desc' : 'asc';
      currentSort = { key, direction };

      filteredCustomers.sort((a, b) => {
        let valA = a[key]?.toLowerCase() || '';
        let valB = b[key]?.toLowerCase() || '';
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
      });

      renderTable();
    }

    document.getElementById('searchInput').addEventListener('input', e => {
      const val = e.target.value.toLowerCase();
      filteredCustomers = customers.filter(c =>
        Object.values(c).some(v => String(v).toLowerCase().includes(val))
      );
      currentPage = 1;
      renderTable();
    });

    function exportToCSV() {
      let csv = 'First Name,Last Name,Email,Phone,Gender,Address,DOB\n';
      filteredCustomers.forEach(c => {
        csv += `${c.first_name},${c.last_name},${c.email},${c.phone},${c.gender},${c.address},${c.dob}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'customers.csv';
      link.click();
    }

    getToken().then(fetchCustomers);
  </script>
</body>
</html>

